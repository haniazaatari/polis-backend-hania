---
import Layout from '../pages/layouts/Layout.astro';
import Header from '../components/Header.astro';
import Survey from '../components/Survey.jsx';
import SurveyForm from '../components/SurveyForm.jsx'; 
import TopicAgenda from '../components/topicAgenda/TopicAgenda.jsx';
import { getTranslations } from '../strings/strings.js';

const { conversation_id } = Astro.params;
let initialData;
let fetchError = null;
let reportData = null;
let commentsData = null;

try {
  const apiParams = new URLSearchParams({
    conversation_id: conversation_id,
  });

  const xid = Astro.url.searchParams.get('xid');
  const x_name = Astro.url.searchParams.get('x_name');
  const x_profile_image_url = Astro.url.searchParams.get('x_profile_image_url');

  if (xid) {
    apiParams.append('xid', xid);
  }
  if (x_name) {
    apiParams.append('x_name', x_name);
  }
  if (x_profile_image_url) {
    apiParams.append('x_profile_image_url', x_profile_image_url);
  }

  const apiUrl = `${import.meta.env.INTERNAL_SERVICE_URL}/participationInit?conversation_id=${conversation_id}`;
  
  const response = await fetch(apiUrl);
  if (!response.ok) {
    throw new Error(`API request failed with status: ${response.status}`);
  }
  initialData = await response.json();
  console.log('Initial data:', initialData);
  console.log('Conversation object:', initialData?.conversation);
  
  // Check if topic prioritization is available for this conversation
  try {
    const topicPrioritizeResponse = await fetch(
      `${import.meta.env.PUBLIC_SERVICE_URL}/participation/topicPrioritize?conversation_id=${conversation_id}`
    );
    
    if (topicPrioritizeResponse.ok) {
      const topicPrioritizeData = await topicPrioritizeResponse.json();
      console.log('Topic prioritize check:', topicPrioritizeData);
      
      if (topicPrioritizeData.has_report && topicPrioritizeData.report_id) {
        reportData = {
          report_id: topicPrioritizeData.report_id,
          conversation_id: topicPrioritizeData.conversation_id
        };
        
        // Also fetch comments for the TopicAgenda
        // Use the original zinvite for the comments API, not the numeric conversation_id
        const commentsResponse = await fetch(
          `${import.meta.env.PUBLIC_SERVICE_URL}/comments?conversation_id=${conversation_id}&moderation=true&include_voting_patterns=true`
        );
        
        if (commentsResponse.ok) {
          commentsData = await commentsResponse.json();
          console.log(`Found ${commentsData.length} comments for topic prioritization`);
        }
      }
    }
  } catch (err) {
    console.error("Failed to check topic prioritization availability:", err);
  }
} catch (error) {
  console.error("Failed to fetch conversation data:", error);
  fetchError = "Could not load this conversation. Please check the ID and try again.";
}

const s = await getTranslations();

let surveyDetails, firstStatement, isConversationActive;
if (initialData) {
  surveyDetails = {
    title: initialData.conversation.topic,
    description: initialData.conversation.description,
  };
  
  firstStatement = {
    tid: initialData.nextComment?.tid,
    txt: initialData.nextComment?.txt,
    remaining: initialData.nextComment?.remaining,
  };

  isConversationActive = initialData.conversation.is_active;
}
---
<Layout title={surveyDetails?.title ?? 'Loading Conversation...'}>
  <div class="container">
    <Header />

    {fetchError ? (
      <div class="error-message">
        <h2>Oops!</h2>
        <p>{fetchError}</p>
      </div>
    ) : initialData ? (
      <>
        <h1>
          {surveyDetails?.title}
          {!isConversationActive && <span class="closed-badge">closed</span>}
        </h1>
        <p class="description" set:html={surveyDetails?.description}></p>

        {isConversationActive ? (
          <>
            <p class="conversation-intro" set:html={s.participantHelpWelcomeText}></p>
            <Survey 
              client:load 
              initialStatement={firstStatement}
              conversation_id={initialData.conversation.conversation_id}
              s={s} 
            />
            <SurveyForm client:load s={s} conversation_id={conversation_id} />
            
            {/* Topic Agenda - only show if we have report and comments data */}
            {reportData && commentsData ? (
              <TopicAgenda 
                client:load
                conversation={initialData.conversation}
                report_id={reportData.report_id}
                comments={commentsData}
              />
            ) : (
              <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666;">
                <p style="margin: 0; font-size: 0.9rem;">
                  Topic Agenda not available yet. 
                  {!reportData && " (No report found)"}
                  {reportData && !commentsData && " (No comments found)"}
                </p>
              </div>
            )}
          </>
        ) : (
          <div class="footer-spacer"></div>
        )}
      </>
    ) : (
      <p>Loading...</p>
    )}

    <div style="margin-top: 3rem;">
      <div class="logo">p</div>
      <div class="footer-links">
        <a href="/privacy" target="_blank" rel="noopener noreferrer">{s.privacy}</a>
        <a href="/tos" target="_blank" rel="noopener noreferrer">{s.TOS}</a>
      </div>
    </div>
  </div>
</Layout>
<style>

</style>
