name: Delphi Python Tests

on:
  push:
    branches: [ edge, stable ] # Matches your e2e config
  pull_request:
    branches: [ edge, stable ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: 1. Free up disk space on runner
      run: |
        echo "Starting disk cleanup..."
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/share/powershell
        echo "Disk space after cleanup:"
        df -h

    - name: 2. Create .env file for CI
      run: |
        # Use test.env as the .env file for this job
        # This ensures docker-compose reads the correct test credentials
        if [ -f "test.env" ]; then
          cp test.env .env
          echo "Using test.env for CI."
        else
          echo "::error::test.env file not found!"
          exit 1
        fi

    - name: 3. Build Docker images
      run: |
        # Build all services defined in the test compose file
        # This is where the "No space left" error was happening
        # We must use docker-compose.test.yml and the .env file
        docker compose \
          -f docker-compose.test.yml \
          --env-file .env \
          build

    - name: 4. Start all services
      run: |
        # Start all services in detached mode
        # This will include postgres, dynamodb, and delphi
        docker compose \
          -f docker-compose.test.yml \
          --env-file .env \
          up -d
        
        # Wait for services to be ready
        echo "Waiting for services to start..."
        sleep 30
        
        # Show running containers
        docker compose -f docker-compose.test.yml ps

    - name: 5. Run Delphi Pytest
      run: |
        # Now, we execute our test command *inside* the
        # already-running 'delphi' container
        docker compose \
          -f docker-compose.test.yml \
          exec -T \
          -v "${{ github.workspace }}/delphi/tests:/app/tests" \
          delphi \
          bash -c "pip install pytest && pytest /app/tests"

    - name: 6. Show service logs on failure
      if: failure()
      run: |
        echo "=== Delphi service logs ==="
        docker compose -f docker-compose.test.yml logs delphi || true
        echo "=== Postgres service logs ==="
        docker compose -f docker-compose.test.yml logs postgres || true
        echo "=== DynamoDB service logs ==="
        docker compose -f docker-compose.test.yml logs dynamodb || true

    - name: 7. Clean up services
      if: always()
      run: |
        # Shut down all services and remove volumes
        echo "Cleaning up services..."
        docker compose -f docker-compose.test.yml down -v