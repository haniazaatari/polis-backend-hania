name: Delphi Python Tests

on:
  push:
    branches: [ edge, stable ]
  pull_request:
    branches: [ edge, stable ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: 1. Free up disk space on runner
      run: |
        echo "Starting disk cleanup..."
        df -h
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /usr/local/share/powershell
        echo "Disk space after cleanup:"
        df -h

    - name: 2. Create .env file for CI
      run: |
        if [ -f "test.env" ]; then
          cp test.env .env
          echo "Using test.env for CI."
        else
          echo "::error::test.env file not found!"
          exit 1
        fi
        
        # Add hostnames for container-to-container networking
        echo "POSTGRES_HOST=postgres" >> .env
        echo "DYNAMODB_ENDPOINT=http://dynamodb:8000" >> .env
        echo "AWS_S3_ENDPOINT=http://minio:9000" >> .env

    - name: 3. Build Docker images
      run: |
        # Use the test-specific compose file
        docker compose -f docker-compose.test.yml --env-file .env build

    - name: 4. Start all services
      run: |
        # Start all services (including delphi) in detached mode
        docker compose -f docker-compose.test.yml --env-file .env up -d
        
        echo "Waiting for services to be healthy..."
        sleep 30 # Initial wait
        docker compose -f docker-compose.test.yml ps

    - name: 5. Check service health
      run: |
        # Run health checks from the runner, hitting localhost
        # This mimics the cypress-run workflow exactly
        
        echo "Checking postgres..."
        docker compose -f docker-compose.test.yml exec -T postgres pg_isready -U postgres

        echo "Checking server API (via nginx-proxy on localhost)..."
        curl -f --retry 12 --retry-delay 10 --retry-connrefused http://localhost/api/v3/participationInit
        
        echo "All services are ready!"

    - name: 6. Set up Python for Download Script
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' 
        
    - name: 7. Install Download Script Dependencies
      run: |
        # Install script dependencies into the *runner's* environment
        pip install psycopg2-binary requests python-dotenv

    - name: 8. Run Data Download Script
      run: |
        # Run the script on the RUNNER, not in a container
        # It will connect to localhost:80 (nginx) and localhost:5432 (postgres)
        # This requires .env to have POSTGRES_HOST=localhost
        echo "POSTGRES_HOST=localhost" >> .env
        
        cd delphi/tests
        python download_real_data.py r4tykwac8thvzv35jrn53 r6vbnhffkxbd7ifmfbdrd
        cd ../..
        
        echo "Data downloaded. Listing real_data contents:"
        ls -lR delphi/real_data

    - name: 9. Run Delphi Pytest
      run: |
        # Now we EXEC into the running 'delphi' container
        # We also mount the data we just downloaded
        docker compose \
          -f docker-compose.test.yml \
          --env-file .env \
          exec -T \
          -v "${{ github.workspace }}/delphi/real_data:/app/delphi/real_data" \
          delphi \
          bash -c " \
            echo '--- Installing Pytest ---'; \
            pip install pytest; \
            echo '--- Running Pytest ---'; \
            pytest /app/delphi/tests \
          "

    - name: 10. Show service logs on failure
      if: failure()
      run: |
        echo "=== Delphi service logs ==="
        docker compose -f docker-compose.test.yml logs delphi || true
        echo "=== Postgres service logs ==="
        docker compose -f docker-compose.test.yml logs postgres || true
        echo "=== DynamoDB service logs ==="
        docker compose -f docker-compose.test.yml logs dynamodb || true
        echo "=== Nginx service logs ==="
        docker compose -f docker-compose.test.yml logs nginx-proxy || true

    - name: 11. Clean up services
      if: always()
      run: |
        echo "Cleaning up services..."
        docker compose -f docker-compose.test.yml down -v